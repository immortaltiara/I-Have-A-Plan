# 第五周事务总结
---
## 总述

这周主要是去了心动的夏令营（蹭五星级酒店和食堂）。题目为坦克大战，开发时间3天左右，由于浪费了很多时间在不必要的地方导致实际的思考和编写时间不够，倒在第二轮。具体的在详细里面说明。

---
## 夏令营内容
### 规则
坦克大战ai编写
对战规则：每人编写自己的坦克AI，通过局域网进行对战，分数高者胜出。
游戏规则：
* 游戏时间5分钟
* 坦克血量10，速度8
* 常规子弹伤害为3，速度为18，存活时间1s，与墙碰撞后消失
* 地图被划分为九个区域，每个区域都拥有一个道具（血包，子弹，盾）
* 子弹击中他人坦克得一分，击杀得3分
* 血包：回复3血，满血时不可拾取
* 红色子弹：伤害为5，蓝色子弹：存活时间3s，与墙碰撞后反弹
* 盾：最大层数为3，满层数时不可拾取，拾取后刷新为最大层数，每层盾可抵挡一发子弹（无视类型）

### 思考过程
一开始想到给每个坦克的动作赋予不同的权值，用状态机或者行为树来决定坦克的行为，后来舍友给我看了个视频，说这种有可能通过神经网络来解决。

[在这先把GitHub链接放上](https://github.com/trulyspinach/Unity-Neural-Network-Tanks-AI)
[B站对应视频](https://www.bilibili.com/video/av14819865)

神经网络除去原有框架外，本质上就是一个随机数据选优的过程。只要能将坦克的移动量化以后，就可以让他们自己打架选出更优质（指得分高）的坦克。
示例Input有五个输入：最近坦克的距离，最近坦克的角度，是否可以发子弹，最大速度和最大角速度，输出则有三个，为转向，前进或后退，发子弹。
但由于这个场景有建筑物和道具，数据还没想好怎么量化，问过导师和学长，导师说这种场景下可能要把整幅地图全部当成数据扔进去……当时觉得输入数据太多了，就放弃了这个想法，浪费了一天半的时间（后面把决策方式搞明白了发现还是可以用神经网络233，其实是走反了，把两个过程反过来说不定就编出来了）

第二步就开始琢磨坦克的逻辑。总体上就是分为三个：自瞄，躲避，决策
* 自瞄
   已知子弹速度为18，坦克速度为8，坦克前进方向为transform.forward，那么可以取巧不用三角函数，可以从敌方坦克的前进方向衍生出一条射线，在射线上逐个取点。一开始取的点离敌方近，离我方远，比值小于8：18。当找到第一个点能使得距离比第一次大于8：18时，说明我方朝这个角度发射子弹，若敌方不改变方向，则可以命中。
   当取点距离大于18*1时，说明敌方已出射程，不需要发射子弹。
   朝发子弹的方向发射射线，若路上会遇到障碍物，则不需要发射子弹。

PS：接口中给的AimAndShoot()函数，在坦克近距离的时候有些小Bug，不会自动开炮，要是实在一点的话可以用Rotate()转向以及直接Shoot()。

* 躲避
与自瞄同理，当对方子弹前进方向与我方方向第一次大于18：8时，说明该子弹会命中我方。此时取消先前决策，朝子弹的右方向开始躲避，若右方向会撞墙，则转至左方向。

躲避行为中，navmesh生成路线需要时间，不能直接拿生成路线用于if判断，需要中间函数isPath()来判断是否已经生成路径，然后再对路径做操作，否则会产生Bug。

* 决策
  将每个道具与坦克列入一个list，赋予不同道具权值，每帧按照最小权值×对应道具距离进行行动（这里因为时间问题没有调好）。
  临时权值：
        * 坦克：满血时权值为8，残血时权值为3，按照公式进行权值赋予。（8-（10-血量）/9*5）
        * 盾：满盾时权值为正无穷，盾不满时权值为1（该道具性价比最高）
        * 子弹：红子弹权值为2，蓝子弹权值为8
        * 血包：满血时权值为正无穷，血量为6-9时权值为5，血量小于等于五，权值为2
        每一帧根据自身状态给予各种操作一个权值，乘上距离后，选择最小的一个道具或坦克进行移动。若是道具则拾取道具，若是坦克则进行追击。
        （其实列完这个逻辑才发现这个根本就可以直接用神经网络输入进去让后找局部最优的权值，所以才说我这几天想反了）


---
列出冠军的想法：
       将地图分为九个区域，根据权值判断自己下一个要去的区域是哪里。
       道具：记录道具出现的时间，以及自己是否离道具最近。若距离/坦克速度小于道具出现时间，则当该道具已经出现来计算。若未出现，权值为0.
       坦克：计算区域内有多少坦克。比自己强的坦克（分值比自身高）的权值为负，比自己弱的坦克权值为正。
       计算完以后，按照权值选择一个最高的区域。若为道具区域，则直接去到道具生成点。若为坦克聚集地，则进入该区域后开始躲避。
       道具时间有一个成员记录，但是我当时没有注意到这个函数。挂在在自身坦克上的脚本会因为坦克被击毁（setactive（false））而进入不运行状态，计时器就不能正确计时。但是通过外部成员获取到的道具生成时间则一定是准确的，可以根据他来判断道具生成时间。
       在场还有一位老哥是成功运用了神经网络来进行坦克逻辑输入的。他将地图分成了50*50的板块依次输入到网络中，得出下一步应该去的敌方，同时还不停进行规避动作。表现现象为可以抽风躲开所有远距离子弹的同时前往目的地。后来针对这位老哥，我设置了莽夫AI（不与坦克保持距离，直接冲上去，距离够近的时候子弹必中）。
 
 ---
 
 ### 技术分享
 两次技术分享会，第一次是讲述unity源码操作，从头到尾都是听天书……
 第二次是讲述渲染管线。
 [幻灯片地址（有可能需要科学上网）](https://prezi.com/view/v0bYcxT4jo5VmgIKqCpm/)
 记下的点（用于事后详细查找）：
 * 渲染管线三阶段
    * 应用阶段：batching：合并物体，相机，灯光
    * 剔除阶段：将相机不显示的物体剔除掉
* 渲染路径：怎么用光去照亮物体，怎样遍历物体
* 前向渲染：计算物体受几盏灯光的影响
拿到列表后遍历整个列表，绘制物体
缺点：物体多了以后，每多一盏灯光，遍历次数就需要加多一次。
* 延迟渲染：先不考虑光照
gBuffer读入所有物体，拆开一重for循环，时间复杂度减少很多
手机上不使用延迟渲染的原因：有硬件要求，显卡支持mrt（多物体），深度图；具有其他弊端
gpu有五倍的画图压力，耗电显著增加
几何阶段
模型坐标转化为屏幕坐标，两个投影矩阵，锥形矩阵（透视图），方形矩阵
* srp可编程渲染管线
允许编写简单脚本来控制rendering，可对渲染管线做出调整，跟shader不兼容。
unity 内置两个srp框架：HDRP和LWRP（只支持前端渲染）
Lit shader
watersyste

unity常用的提升demo编写速率的插件：
    odin策划使用，右方工具栏扩展插件
    nodecanvas行为树插件
    bolt提升调试效率插件
    插件使用范围：
    小型demo制作，用于验证想法， 提升编码效率。
    不适用于大型项目，或者在大型项目中会限定使用范围

Unity新的ecs实体组建系统
改变代码规则，用于写出高效代码
在成千上万个游戏实体的时候比起原来具有又是
显式和逻辑拆分
提供安全的写出多线程的途径
任务系统
burst编译器
目前开发效率不高

---
题外话：
这个项目真的超级好玩
这么多次活动下来，我发现这个行业无论是从业者还是参与者，似乎都留着一份孩子气。这大概就是我们之间比较容易相处的原因？交流起来会比较舒服。第一天完全不熟的一堆人，有人掏出switch连上大屏幕开了喷射和马车8，马上就开始玩起来了233。
还是挺喜欢玩家这种纯粹一点的相处交流方式，不需要来回试探或者揣测情绪啥的，多省心（）

